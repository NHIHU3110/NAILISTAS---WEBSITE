<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Đăng nhập — Nailistas Việt Nam</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../Login/style.css">
</head>
<body>
  
  <article class="card" role="application">
    <section class="side">
      <div class="logo"></div>
      <h1>Chào mừng trở lại</h1>
      <p>Đăng nhập để tiếp tục trải nghiệm dịch vụ làm đẹp chuyên nghiệp và mua sắm sản phẩm chăm sóc móng cao cấp.</p>
      <ul>
        <li>Truy cập lịch hẹn của bạn</li>
        <li>Theo dõi đơn hàng và ưu đãi</li>
        <li>Lưu sản phẩm yêu thích</li>
        <li>Nhận thông báo khuyến mãi đặc biệt</li>
      </ul>
    </section>

    <section class="main">
      <h2>Đăng nhập</h2>
      <p>Nhập thông tin tài khoản của bạn để tiếp tục</p>

      <form id="form-login" novalidate>
        <label>
          Email
          <input type="email" id="login-email" placeholder="you@example.com" autocomplete="email" required/>
          <div class="error" id="login-email-err"></div>
        </label>

        <label class="field-suffix">
          Mật khẩu
          <input type="password" id="login-password" placeholder="Nhập mật khẩu của bạn" autocomplete="current-password" required/>
          <button class="toggle-eye" type="button" data-for="login-password" aria-label="Hiện/ẩn mật khẩu"></button>
          <div class="error" id="login-password-err"></div>
        </label>

        <div class="actions">
          <label class="remember">
            <input type="checkbox" id="remember-me"/> Ghi nhớ đăng nhập
          </label>
          <span style="flex:1"></span>
        </div>

        <div class="actions">
          <button class="btn" type="submit" style="flex:1">Đăng nhập</button>
        </div>

        <div class="error" id="login-general"></div>
        <p class="footer">Chưa có tài khoản? <a href="../Login/signup.html">Đăng ký ngay</a> để nhận ưu đãi đặc biệt!</p>
      </form>
    </section>
  </article>
  <!-- Transition overlay -->
  <div id="transition-overlay">
    <img src="../images/nail logo-01.png" alt="Logo chuyển trang">
  </div>

  <script src="../Login/auth.js"></script>
  <script>
    const Auth = window.AuthUtils;
    try { Auth.initToggleEye && Auth.initToggleEye(); } catch {}
    // Prefill email: ưu tiên pending từ signup, sau đó mới đến remembered
    window.addEventListener("DOMContentLoaded", () => {
      const pending = sessionStorage.getItem("sv_pending_email");
      const saved = localStorage.getItem("sv_last_email");
      if (pending) {
        document.getElementById("login-email").value = pending;
        document.getElementById("remember-me").checked = true;
        sessionStorage.removeItem("sv_pending_email");
      } else if (saved) {
        document.getElementById("login-email").value = saved;
        document.getElementById("remember-me").checked = true;
      }
    })

    // ===== Xử lý đăng nhập =====
    document.getElementById("form-login").addEventListener("submit", (e) => {
      e.preventDefault();
      ["login-email-err","login-password-err","login-general"].forEach(id => { 
        const el=document.getElementById(id); 
        if(el) el.textContent=""; 
      });

      const email = document.getElementById("login-email").value.trim().toLowerCase();
      const pw = document.getElementById("login-password").value;

      if(!Auth.emailRe.test(email)){
        document.getElementById("login-email-err").textContent = "Vui lòng nhập địa chỉ email hợp lệ";
        return;
      }
      if(!pw){
        document.getElementById("login-password-err").textContent = "Vui lòng nhập mật khẩu";
        return;
      }

      const users = Auth.loadUsers();
      const digest = Auth.hashPassword(pw);
      const user = users.find(u => u.email === email && u.pw === digest);

      if(!user){
        document.getElementById("login-general").textContent = "Email hoặc mật khẩu không chính xác. Vui lòng thử lại.";
        return;
      }

      // Ghi nhớ email nếu chọn
      if(document.getElementById("remember-me").checked){
        localStorage.setItem("sv_last_email", email);
      } else {
        localStorage.removeItem("sv_last_email");
      }

      // QUAN TRỌNG: setCurrentUser để ck.html nhận phiên đăng nhập
      Auth.setCurrentUser(user);

      if (user.role === 'admin') {
  // Cách nhanh: confirm. Thay bằng modal nếu muốn UI đẹp hơn.
  const goAdmin = confirm("Bạn đăng nhập bằng tài khoản Admin.\nOK = vào Admin Dashboard. Cancel = vào Trang chủ.");
  if (goAdmin) {
    // chuyển sang admin dashboard
    window.location.href = "../Admin/admin.html";
  } else {
    goHome(); // hàm hiện có trong auth.js, chuyển về ck.html
  }
} else {
  // user thường -> về home
  goHome();
}
    });
    

  </script>

<script>
(async function importUsersFromJsonOnce(){
  const FLAG = 'sv_users_imported';
  if(localStorage.getItem(FLAG)) return; // tránh import lặp
  try{
    const res = await fetch('../Login/users.json'); // chỉnh đường dẫn đúng cấu trúc của bạn
    if(!res.ok) return;
    const raw = await res.json();
    const Auth = window.AuthUtils;
    const existing = Auth.loadUsers();
    const map = new Map(existing.map(u => [u.email, u]));
    raw.forEach(u => {
      if(!u?.email) return;
      // nếu pw chưa băm thì băm
      const hashed = (u.pw && u.pw.length < 20) ? Auth.hashPassword(u.pw) : u.pw;
      map.set(u.email.toLowerCase(), {
        name: u.name || '',
        email: u.email.toLowerCase(),
        pw: hashed,
        role: u.role || 'user',
        createdAt: u.createdAt || Date.now()
      });
    });
    const merged = Array.from(map.values());
    Auth.saveUsers(merged);
    localStorage.setItem(FLAG, '1');
    console.log('Imported users.json');
  }catch(e){ console.warn('Import users.json failed', e); }
})();
</script>
<script>
  (function seedAdminFix(){
    const Auth = window.AuthUtils;
    if(!Auth) return;
    const users = Auth.loadUsers();
    const email = 'admin@gmail.com';
    const pass  = 'Admin@123';
    if (!users.some(u => u.email === email)) {
      users.push({
        name: "Admin Nailistas",
        email,
        pw: Auth.hashPassword(pass),   // phải băm
        role: "admin",
        createdAt: Date.now()
      });
      Auth.saveUsers(users);
      console.log('Đã tạo tài khoản admin');
    } else {
      console.log('⚙️ Admin đã tồn tại');
    }
  })();
</script>

</body>
</html>
