<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>S·∫£n ph·∫©m d·ª•ng c·ª• nail | Nailistas</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    :root {
      --brand: #1935e1;
      --bg: #feffef;
      --ink: #222;
      --accent: #540d3e;
      --soft: #f5f5dc;
      --danger: #ff4d6d;
    }

    body { background-color: var(--bg); font-family: 'Segoe UI', sans-serif; margin:0; padding:0; }

    /* üîπ HEADER */
    header {
      position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
      background-color: var(--brand); height: 80px; width: 100%;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 40px; box-sizing: border-box;
    }
    .nav-left, .nav-right { display: flex; gap: 20px; align-items: center; }
    .logo-center {
      position: absolute; left: 50%; transform: translateX(-50%);
      display: flex; align-items: center; justify-content: center;
    }
    .logo-center img { height:60px; cursor:pointer; transition: transform .4s ease; }
    .logo-center img:hover { transform: scale(1.1); }

    header a {
      position: relative; color:#fff; text-decoration:none; font-weight:500; font-size:1rem; transition: color .3s ease;
    }
    header a::after {
      content:""; position:absolute; bottom:-4px; left:50%; transform: translateX(-50%) scaleX(0); transform-origin:center;
      width:100%; height:2px; background-color:#fff; transition: transform .3s ease;
    }
    header a:hover::after, header a.active::after { transform: translateX(-50%) scaleX(1); }

    /* Cart badge */
    #cart-link { display: inline-flex; align-items: center; gap: 8px; }
    .badge {
      display:inline-flex; align-items:center; justify-content:center; min-width: 22px; height:22px;
      padding: 0 6px; background:#fff; color: var(--brand); border-radius: 999px; font-size: 12px; font-weight: 700;
    }

    /* Keep content below fixed header */
    main { padding-top: 96px; }

    /* üîπ Page transition overlay */
    #transition-overlay {
      position: fixed; inset: 0; background-color: var(--brand); opacity: 0; display: none;
      justify-content:center; align-items:center; transition: opacity .6s ease; z-index: 2000;
    }

    /* Back button */
    #back-button {
      position: fixed; top: 100px; left: 20px; background: transparent; border: none; cursor: pointer;
      width: 42px; height: 42px; padding: 0; z-index: 999;
    }
    #back-button img { width:38px; height:38px; transition: transform .2s ease; }
    #back-button:hover img { transform: translateX(-3px); }

    h2 { color: var(--brand); text-align: center; margin: 24px 0 8px; }

    .filter-bar { width: 90%; margin: 10px auto 0; text-align: right; }
    label[for=sortFilter] { margin-right: 8px; color: #333; }
    select { padding: 8px 12px; border: 1px solid var(--brand); border-radius: 6px; font-size: 15px; cursor: pointer; background:#fff; }

    /* --- Product grid --- */
    .product-container {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 280px)); gap: 25px; justify-content: center;
      width: 100%; max-width: 1200px; margin: 25px auto;
    }
    .product-card {
      background:#fff; border-radius:16px; overflow:hidden; box-shadow: 0 4px 8px rgba(0,0,0,.05);
      transition: transform .2s ease; cursor:pointer; width:280px; height: 420px; display:flex; flex-direction:column;
      border: 1px solid var(--soft);
    }
    .product-card:hover { transform: translateY(-5px); }
    .product-card img { width:100%; height: 240px; object-fit: cover; border-bottom: 1px solid #eee; }

    .product-info { display:flex; justify-content: space-between; align-items:center; padding: 12px 16px; flex-grow:1; }
    .product-text { text-align:left; flex:1; }
    .product-text h3 { color: var(--ink); margin:0; font-size:17px; font-weight:600; }
    .product-text p { color: var(--accent); font-weight:500; margin-top: 6px; font-size: 14px; }

    .btn-cart { background:none; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; margin-left:10px; }
    .btn-cart img { width:24px; height:24px; transition: transform .3s ease; }
    .btn-cart:hover img { transform: scale(1.1); }

    #pagination { display:flex; justify-content:center; margin: 30px 0; flex-wrap:wrap; gap: 6px; }
    #pagination button {
      padding: 6px 12px; border-radius: 6px; border: 1px solid var(--brand); background:#fff; color: var(--brand); cursor:pointer;
    }
    #pagination button.active, #pagination button:hover { background: var(--brand); color:#fff; }

/* ==== CART OVERLAY + POPUP (drawer b√™n ph·∫£i) ==== */
#overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,.4);
  display: block;              /* ƒë·ªÉ click ƒë∆∞·ª£c khi drawer m·ªü */
  opacity: 0; visibility: hidden;
  transition: opacity .25s ease; z-index: 1900;
}
#overlay.show { opacity: 1; visibility: visible; }

/* Drawer n·∫±m d∆∞·ªõi header cao 80px ‚Äì b√°m s√°t m√©p ph·∫£i */
#cart-popup {
  position: fixed; top: 80px; right: 0; bottom: 0;
  width: min(680px, calc(100% - 24px));   /* gi·ªØ ƒë√∫ng chi·ªÅu r·ªông c≈©, c√≥ responsive */
  background: #fff; border-radius: 20px 0 0 20px;
  border-left: 1px solid #eee;
  box-shadow: -12px 0 30px rgba(0,0,0,.18);
  overflow: hidden; z-index: 2001;

  /* hi·ªáu ·ª©ng tr∆∞·ª£t t·ª´ ph·∫£i ra */
  transform: translateX(100%);
  opacity: 0;
  transition: transform .28s ease, opacity .28s ease;
}
#cart-popup.open { transform: translateX(0); opacity: 1; }

/* Gi·ªØ nguy√™n style ti√™u ƒë·ªÅ/n√∫t ƒë√≥ng nh∆∞ b·∫°n ƒëang c√≥ */
#cart-popup h3 {
  margin: 0; padding: 16px 24px; text-align: center;
  color: var(--brand); font-size: 22px; font-weight: 700; background: #fff;
  border-bottom: 1px solid #f0f0f0; /* th√™m ƒë∆∞·ªùng vi·ªÅn nh·∫π cho gi·ªëng ·∫£nh */
}
#cart-popup .close-btn {
  position: absolute; left: 16px; top: 14px;
  background: transparent; border: none; color: var(--brand);
  font-size: 22px; cursor: pointer; line-height: 1;
}

/* Ph·∫ßn list cao b·∫±ng chi·ªÅu cao drawer (tr·ª´ footer) ƒë·ªÉ footer d√≠nh ƒë√°y */
.cart-content {
  height: calc(100% - 160px);   /* 160px ‚âà header + footer c·ªßa b·∫°n */
  overflow: auto;
  padding: 8px 24px 12px;
}

/* Gi·ªØ nguy√™n c√°c item ‚Äì kh√¥ng ƒë·ªïi m√†u/th√†nh ph·∫ßn */
.cart-item {
  display: grid; grid-template-columns: 64px 1fr auto; gap: 12px; align-items: center;
  padding: 12px 0; border-bottom: 1px solid #eee;
}
.cart-item:last-child { border-bottom: none; }
.cart-item img {
  width:64px; height:64px; border-radius: 10px; object-fit: cover; border: 1px solid #eee;
}
.cart-item-info h4 { margin: 0; font-size: 15px; color: #222; }
.bottom-row { margin-top: 6px; display:flex; align-items:center; gap: 12px; }
.bottom-row p { margin-left: auto; color: #222; font-weight: 600; }

.quantity-box {
  display:inline-flex; align-items:center; gap: 8px;
  background: #e9eeff; padding: 6px 8px; border-radius: 8px;
}
.qty-btn {
  width: 28px; height: 28px; border-radius: 6px; border: none;
  cursor: pointer; background: var(--brand); color:#fff; font-weight: 700;
}
.qty-input {
  width: 40px; height: 28px; text-align: center; border: none; background: #fff; border-radius: 6px; font-weight: 700;
}
.remove-btn {
  background: none; border:none; color: var(--brand); cursor: pointer; font-size: 18px; line-height: 1;
}

/* Footer xanh d√≠nh ƒë√°y ‚Äì gi·ªØ nguy√™n m√†u s·∫Øc */
.checkout-container {
  position: sticky; bottom: 0; background: var(--brand); color: #fff;
  padding: 18px 24px; display: flex; align-items: center; justify-content: space-between; gap: 14px;
  border-top-left-radius: 18px;
}
.checkout-text { font-weight: 700; }
.checkout-text span { display: block; margin-top: 8px; font-size: 26px; letter-spacing: .3px; }
.checkout-btn {
  padding: 12px 18px; background: var(--danger); color: #fff; border: none; border-radius: 12px; cursor: pointer; font-weight: 700;
  box-shadow: 0 0 0 rgba(255,77,109,0); transition: box-shadow .2s ease, transform .05s ease;
}
.checkout-btn:hover { box-shadow: 0 0 24px rgba(255,77,109, .5); }
.checkout-btn:active { transform: translateY(1px); }

@media (max-width: 768px) {
  #cart-popup { width: calc(100% - 8px); } /* g·∫ßn full width tr√™n mobile */
}


    /* Scroll to top */
    #scrollTopBtn {
      position: fixed; bottom: 30px; right: 30px; background-color: var(--bg); border: 1px solid #ccc; border-radius: 10px; padding:10px; cursor:pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,.15); opacity: 0; visibility: hidden; transition: opacity .4s ease, transform .3s ease, visibility .4s; z-index: 999;
    }
    #scrollTopBtn.show { opacity: 1; visibility: visible; }
    #scrollTopBtn img { width:26px; height:26px; }
    #scrollTopBtn:hover { transform: scale(1.1); box-shadow: 0 6px 12px rgba(0,0,0,.25); }

    footer { background-color: #fff8f0; padding: 40px 20px; text-align: center; border-top: 1px solid var(--soft); margin-top: 40px; }
    .footer-container { display:flex; justify-content: space-around; flex-wrap:wrap; margin-bottom: 20px; }
    .footer-section { margin:10px; }
    .footer-section h3 { color: var(--brand); margin-bottom:10px; }
    .footer-section a { color: var(--accent); text-decoration: none; }
    .footer-section a:hover { text-decoration: underline; }

    @media (max-width: 768px) {
      .product-card { width: 220px; height: 360px; }
      .product-card img { height: 200px; }
      #cart-popup { width: calc(100% - 16px); }
    }
  </style>
</head>
<body>
  <!-- üîπ HEADER -->
  <header>
    <div class="nav-left">
      <a href="../Blog/Blog.html" data-transition>Blog</a>
      <a href="../Booking/Booking.html" data-transition>ƒê·∫∑t l·ªãch</a>
      <a href="Product.html" data-transition>S·∫£n ph·∫©m</a>
      <a href="../Service/service.html" data-transition>D·ªãch v·ª•</a>
    </div>
  
    <div class="logo-center">
      <img src="../images/nail logo-01.png" alt="Logo Nailistas" onclick="goHome()">
    </div>
  
    <div class="nav-right">
      <a href="../contact/contact.html" data-transition>Li√™n h·ªá</a>
      <a href="../Cart/cart.html" id="cart-link">Gi·ªè h√†ng <span id="cart-count" class="badge">0</span></a>
      <a href="../Login/login.html" data-transition>ƒêƒÉng nh·∫≠p</a>
      <a href="#" data-auth="logout" style="display: none;" onclick="logout(); return false;">ƒêƒÉng xu·∫•t</a>
      <a href="../Personal/personal.html" data-transition class="account-link">
        <div class="account-avatar" style="display:none;"></div>
      </a>
    </div>
  </header>

  <!-- üîπ Overlay hi·ªáu ·ª©ng chuy·ªÉn trang -->
  <div id="transition-overlay"></div>

  <!-- Back -->
  <button id="back-button" aria-label="Quay l·∫°i">
    <img src="../images/left_arrow.png" alt="Back" />
  </button>

  <main>
    <h2>D·ª§NG C·ª§ C∆† B·∫¢N</h2>

    <div class="filter-bar">
      <label for="sortFilter">S·∫Øp x·∫øp theo:</label>
      <select id="sortFilter">
        <option value="az">T√™n (A ‚Üí Z)</option>
        <option value="za">T√™n (Z ‚Üí A)</option>
        <option value="priceAsc">Gi√° tƒÉng d·∫ßn</option>
        <option value="priceDesc">Gi√° gi·∫£m d·∫ßn</option>
      </select>
    </div>

    <div class="product-container" id="product-container" aria-live="polite"></div>
    <div id="pagination"></div>
  </main>

  <!-- ==== OVERLAY + POPUP GI·ªé H√ÄNG (template) ==== -->
  <div id="overlay"></div>
  <div id="cart-popup" role="dialog" aria-modal="true" aria-labelledby="cartTitle">
    <button class="close-btn" aria-label="ƒê√≥ng">√ó</button>
    <h3 id="cartTitle">Gi·ªè h√†ng (<span id="cart-count-title">0</span>)</h3>
    <div class="cart-content" id="cart-content"></div>
    <div class="checkout-container">
      <div class="checkout-text">
        T·∫°m t√≠nh:
        <span id="cart-total-amount">0 VND</span>
      </div>
      <button class="checkout-btn" id="checkout-btn">Thanh to√°n</button>
    </div>
  </div>

  <!-- üîπ N√∫t l√™n ƒë·∫ßu trang -->
  <button id="scrollTopBtn" title="L√™n ƒë·∫ßu trang"><img src="../images/up_arrow.png" alt="L√™n ƒë·∫ßu trang" /></button>

  <footer>
    <div class="footer-container">
      <div class="footer-section">
        <h3>H·ªá th·ªëng chi nh√°nh</h3>
        <p>üìç 12 Nguy·ªÖn Hu·ªá, Qu·∫≠n 1, TP.HCM</p>
        <p>üìç 25 L√Ω Th∆∞·ªùng Ki·ªát, H√† N·ªôi</p>
        <p>üìç 08 B·∫°ch ƒê·∫±ng, ƒê√† N·∫µng</p>
      </div>
      <div class="footer-section">
        <h3>Li√™n h·ªá</h3>
        <p>üìû Hotline: <strong>0909 888 777</strong></p>
        <p>üìß Email: <a href="mailto:contact@nailistas.vn">contact@nailistas.vn</a></p>
      </div>
      <div class="footer-section">
        <h3>Ch√≠nh s√°ch</h3>
        <p><a href="#">Ch√≠nh s√°ch b·∫£o m·∫≠t</a></p>
        <p><a href="#">ƒêi·ªÅu kho·∫£n d·ªãch v·ª•</a></p>
      </div>
    </div>
    <hr />
    <p>&copy; Nailistas Vi·ªát Nam</p>
  </footer>

  <script>
    // ---------- Helpers ----------
    const overlay = document.getElementById('transition-overlay');
    const productContainer = document.getElementById('product-container');
    const sortSelect = document.getElementById('sortFilter');
    const cartOverlay = document.getElementById('overlay');
    const cartPopup = document.getElementById('cart-popup');
    const cartContent = document.getElementById('cart-content');
    const cartTotalEl = document.getElementById('cart-total-amount');
    const cartCountTitle = document.getElementById('cart-count-title');
    const cartCountEl = document.getElementById('cart-count');

    const itemsPerPage = 15;
    let currentPage = 1;
    let toolEntries = []; // [ [id, product], ... ]
    let productIndex = {}; // { id: product }

    const VND = (n) => (Number(n)||0).toLocaleString('vi-VN') + ' VND';
    const toNumber = (x) => typeof x === 'number' ? x : Number(String(x).replace(/[^0-9.-]/g,'')) || 0;

    // ---------- Page transition for header links ----------
    function showOverlayThenNavigate(url){
      overlay.style.display = 'flex'; overlay.style.opacity = '1';
      setTimeout(()=>{ window.location.href = url; }, 600);
    }
    // Ch·∫∑n ƒëi·ªÅu h∆∞·ªõng cho #cart-link ƒë·ªÉ m·ªü popup
    const headerCartLink = document.getElementById('cart-link');
    if (headerCartLink) {
      headerCartLink.addEventListener('click', (e)=>{
        e.preventDefault(); e.stopPropagation();
        openCartPopup();
      }, true);
    }
    // C√°c link kh√°c v·∫´n c√≥ hi·ªáu ·ª©ng chuy·ªÉn trang
    document.querySelectorAll('header a[data-transition]').forEach(a => {
      a.addEventListener('click', (e)=>{
        if (a.id === 'cart-link') return;
        e.preventDefault(); showOverlayThenNavigate(a.getAttribute('href'));
      });
    });
    document.getElementById('homeLogo').addEventListener('click', ()=> showOverlayThenNavigate('ck.html'));

    // Back button
    document.getElementById('back-button').onclick = () => {
      if (document.referrer) history.back(); else window.location.href = 'Product.html';
    };

    // Scroll to top
    const scrollBtn = document.getElementById('scrollTopBtn');
    window.addEventListener('scroll', ()=>{ if (window.scrollY > 300) scrollBtn.classList.add('show'); else scrollBtn.classList.remove('show'); });
    scrollBtn.addEventListener('click', ()=> window.scrollTo({ top: 0, behavior: 'smooth' }));

    // ---------- Cart state ----------
    function getCart(){ return JSON.parse(localStorage.getItem('cart') || '[]'); }
    function setCart(cart){ localStorage.setItem('cart', JSON.stringify(cart)); }
    function countCart(cart = getCart()){ return cart.reduce((s,it)=> s + (Number(it.quantity)||0), 0); }
    function totalCart(cart = getCart()){ return cart.reduce((s,it)=> s + toNumber(it.price)* (Number(it.quantity)||0), 0); }

    function renderCartBadge(){
      const c = countCart();
      cartCountEl.textContent = c > 99 ? '99+' : String(c);
    }

    // ---------- Popup controls ----------
    function openCartPopup(){
      renderCartPopup();
      cartOverlay.classList.add('show');
      cartPopup.classList.add('open');
    }
    function closeCartPopup(){
      cartPopup.classList.remove('open');
      cartOverlay.classList.remove('show');
    }
    cartOverlay.addEventListener('click', closeCartPopup);
    cartPopup.querySelector('.close-btn').addEventListener('click', closeCartPopup);
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeCartPopup(); });

    // Render n·ªôi dung gi·ªè h√†ng
    function renderCartPopup(){
      const cart = getCart();
      cartContent.innerHTML = '';
      if(cart.length === 0){
        cartContent.innerHTML = '<p style="padding:12px 24px;color:#666;">Gi·ªè h√†ng tr·ªëng.</p>';
        cartCountTitle.textContent = '0';
        cartTotalEl.textContent = VND(0);
        document.getElementById('checkout-btn').disabled = true;
        return;
      }
      document.getElementById('checkout-btn').disabled = false;

      cart.forEach((it, idx)=>{
        const row = document.createElement('div');
        row.className = 'cart-item';
        row.innerHTML = `
          <img src="${it.img}" alt="${it.name}">
          <div class="cart-item-info">
            <h4>${it.name}</h4>
            <div class="bottom-row">
              <div class="quantity-box" data-id="${it.id}">
                <button class="qty-btn" data-action="dec">‚àí</button>
                <input type="number" class="qty-input" value="${it.quantity}" readonly/>
                <button class="qty-btn" data-action="inc">+</button>
              </div>
              <p>${VND(it.price)}</p>
            </div>
          </div>
          <button class="remove-btn" title="X√≥a" aria-label="X√≥a" data-action="remove" data-id="${it.id}">√ó</button>
        `;
        cartContent.appendChild(row);
      });
      cartCountTitle.textContent = String(countCart(cart));
      cartTotalEl.textContent = VND(totalCart(cart));
    }

    // S·ª± ki·ªán +/‚àí/x√≥a trong popup
    cartContent.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-action]');
      if(!btn) return;
      const action = btn.getAttribute('data-action');
      const id = btn.getAttribute('data-id') || btn.parentElement.getAttribute('data-id');
      const cart = getCart();
      const idx = cart.findIndex(x=> String(x.id) === String(id));
      if(idx === -1) return;

      if(action === 'inc') cart[idx].quantity++;
      if(action === 'dec') cart[idx].quantity = Math.max(1, cart[idx].quantity - 1);
      if(action === 'remove') cart.splice(idx,1);

      setCart(cart);
      renderCartBadge();
      renderCartPopup();
    });

    // Thanh to√°n
    // === Checkout ‚Üí chuy·ªÉn sang payment k√®m d·ªØ li·ªáu ===
(function () {
  const btn = document.getElementById('checkout-btn');
  if (!btn) return;

  const PAYMENT_URL = '../html/payment.html'; // ch·ªânh ƒë∆∞·ªùng d·∫´n n·∫øu kh√°c

  const toNumber = v => Number(String(v).replace(/[^\d.-]/g, '')) || 0;

  btn.addEventListener('click', (e) => {
    e.preventDefault();

    // 1) L·∫•y gi·ªè h√†ng t·ª´ localStorage
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    if (!cart.length) { alert('Gi·ªè h√†ng tr·ªëng!'); return; }

    // 2) ƒê√≥ng g√≥i payload
    const items = cart.map(({ id, name, price, quantity, img }) => ({
      id,
      name,
      unitPrice: toNumber(price),
      quantity: Number(quantity) || 1,
      imageSrc: img || ''
    }));
    const subtotal = items.reduce((s, i) => s + i.unitPrice * i.quantity, 0);
    const shipping = 15000;               // payment s·∫Ω t·ª± t√≠nh l·∫°i theo l·ª±a ch·ªçn
    const total = subtotal + shipping;
    const payload = {
      items, subtotal, shipping, total,
      currency: 'VND', locale: 'vi-VN', savedAt: new Date().toISOString()
    };

    // 3) Ghi v√†o sessionStorage + l∆∞u trang ngu·ªìn
    sessionStorage.setItem('checkoutData', JSON.stringify(payload));
    sessionStorage.setItem('paymentOrigin', location.href);

    // 4) ƒêi·ªÅu h∆∞·ªõng sang Payment
    window.location.href = PAYMENT_URL;
  });
})();


    // ---------- Products ----------
    const paginationEl = document.getElementById('pagination');

    function sortEntries(list, type){
      const s = [...list];
      switch(type){
        case 'az': s.sort((a,b)=> a[1].name.localeCompare(b[1].name)); break;
        case 'za': s.sort((a,b)=> b[1].name.localeCompare(a[1].name)); break;
        case 'priceAsc': s.sort((a,b)=> toNumber(a[1].price) - toNumber(b[1].price)); break;
        case 'priceDesc': s.sort((a,b)=> toNumber(b[1].price) - toNumber(a[1].price)); break;
      }
      return s;
    }

    function renderProducts(page=1){
      productContainer.innerHTML = '';
      const start = (page-1)*itemsPerPage;
      theEnd = start + itemsPerPage;
      const pageItems = toolEntries.slice(start, theEnd);

      for(const [id, p] of pageItems){
        const card = document.createElement('div');
        card.className = 'product-card';
        card.innerHTML = `
          <img src="${p.img}" alt="${p.name}" data-href="Product_detail.html?id=${id}" class="prd-link" />
          <div class="product-info">
            <div class="product-text">
              <h3>${p.name}</h3>
              <div class="product-stars" aria-label="X·∫øp h·∫°ng trung b√¨nh" style="color:gold;font-size:22px;line-height:1;margin:6px 0;text-align:left;display:none"></div>
              <p>${VND(p.price)}</p>
            </div>
            <button class="btn-cart" data-id="${id}" title="Th√™m v√†o gi·ªè" aria-label="Th√™m v√†o gi·ªè">
              <img src="../images/cart.png" alt="Cart" />
            </button>
          </div>`;
        productContainer.appendChild(card);
      }

      renderPagination(page);
      renderAverageRatings();
    }

    function renderPagination(page){
      paginationEl.innerHTML = '';
      const totalPages = Math.ceil(toolEntries.length / itemsPerPage);
      for(let i=1;i<=totalPages;i++){
        const btn = document.createElement('button');
        btn.textContent = i; if(i===page) btn.classList.add('active');
        btn.addEventListener('click', ()=>{ currentPage = i; renderProducts(currentPage); });
        paginationEl.appendChild(btn);
      }
    }

    // Delegated events: add-to-cart & image click
    productContainer.addEventListener('click', (e)=>{
      const cartBtn = e.target.closest('.btn-cart');
      const imgLink = e.target.closest('img.prd-link');
      if(cartBtn){
        const pid = cartBtn.getAttribute('data-id');
        const p = productIndex[pid]; if(!p) return;
        const cart = getCart();
        const found = cart.find(it => it.id === pid);
        if(found) found.quantity += 1; else cart.push({ id: pid, name: p.name, price: toNumber(p.price), img: p.img, quantity: 1 });
        setCart(cart);
        renderCartBadge();
        openCartPopup(); // üëâ m·ªü popup ngay, KH√îNG hi·ªán toast
      }
      if(imgLink){
        const href = imgLink.getAttribute('data-href');
        showOverlayThenNavigate(href);
      }
    });

    // Ratings (from localStorage key "ratings" = { [productId]: avgNumber })
    function renderAverageRatings(){
      const ratings = JSON.parse(localStorage.getItem('ratings')||'{}');
      document.querySelectorAll('.product-card').forEach(card=>{
        const pid = card.querySelector('.btn-cart')?.getAttribute('data-id');
        const avg = Math.max(0, Math.min(5, parseFloat(ratings[pid])||0));
        const full = Math.round(avg);
        const stars = '‚òÖ'.repeat(full) + '‚òÜ'.repeat(5-full);
        const box = card.querySelector('.product-stars');
        if(box){ box.style.display='block'; box.innerHTML = `${stars}<span style="color:#444;font-size:15px;margin-left:4px;">(${avg.toFixed(1)})</span>`; }
      });
    }

    // React to storage updates (other tabs/windows)
    window.addEventListener('storage', (e)=>{
      if(e.key === 'cart'){ renderCartBadge(); if(cartPopup.classList.contains('open')) renderCartPopup(); }
      if(e.key === 'ratings'){ renderAverageRatings(); }
    });

    // Sorting
    sortSelect.addEventListener('change', ()=>{ toolEntries = sortEntries(toolEntries, sortSelect.value); renderProducts(1); });

    // ---------- Boot ----------
    fetch('../data/products.json')
      .then(r => r.json())
      .then(products => {
        const entries = Object.entries(products).filter(([_,p])=> p.type === 'tool');
        entries.forEach(([id,p])=> { p.price = toNumber(p.price); });
        toolEntries = sortEntries(entries, 'az');
        productIndex = Object.fromEntries(toolEntries);
        renderProducts(currentPage);
        renderCartBadge();
      })
      .catch(err => {
        console.error('L·ªói load s·∫£n ph·∫©m:', err);
        productContainer.innerHTML = '<p style="color:#c00;text-align:center;">Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch s·∫£n ph·∫©m.</p>';
      });


      
// === Reopen cart drawer when returning from payment ===
(function attachReopenCartListener(){
  function reopenIfNeeded(){
    if (sessionStorage.getItem('reopenCart') === '1') {
      sessionStorage.removeItem('reopenCart');

      // ƒë·ª£i 1 tick cho ch·∫Øc DOM drawer ƒë√£ s·∫µn s√†ng
      setTimeout(() => {
        // ∆∞u ti√™n d√πng h√†m chu·∫©n n·∫øu c√≥
        if (typeof openCartDrawer === 'function') {
          openCartDrawer();
          return;
        }

        // fallback 1: t·ª± th√™m class ƒë·ªÉ m·ªü drawer theo template
        const overlay = document.getElementById('overlay');
        const drawer  = document.getElementById('cart-drawer');
        if (overlay && drawer) {
          overlay.classList.add('show');
          drawer.classList.add('open');
          return;
        }

        // fallback 2: gi·∫£ l·∫≠p click v√†o link gi·ªè h√†ng
        document.getElementById('cart-link')
          ?.dispatchEvent(new MouseEvent('click', {bubbles:true, cancelable:true}));
      }, 0);
    }
  }

  // h·ªó tr·ª£ c·∫£ BFCache (pageshow) l·∫´n load th∆∞·ªùng
  window.addEventListener('pageshow', reopenIfNeeded);
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    reopenIfNeeded();
  } else {
    document.addEventListener('DOMContentLoaded', reopenIfNeeded, { once:true });
  }
})();


  </script>
</body>
</html>
